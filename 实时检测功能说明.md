# å®æ—¶æ£€æµ‹åŠŸèƒ½è¯´æ˜

## ğŸ‰ å·²å®ç°çš„åŠŸèƒ½

### 1. âœ… çœŸå®éŸ³é¢‘æ£€æµ‹
- **éº¦å…‹é£å½•éŸ³**ï¼šå®æ—¶å½•åˆ¶éŸ³é¢‘å¹¶æ¯ 3 ç§’å‘é€åˆ°åç«¯
- **çœŸå®éŸ³é¢‘æ³¢å½¢**ï¼šæ˜¾ç¤ºåŸºäºéº¦å…‹é£å®æ—¶éŸ³é‡çš„æ³¢å½¢å›¾ï¼ˆä¸å†æ˜¯å‡çš„åŠ¨ç”»ï¼‰
- **éŸ³é¢‘æ£€æµ‹ç»“æœ**ï¼šæ¥æ”¶åç«¯è¿”å›çš„ AI åˆæˆéŸ³é¢‘æ£€æµ‹ç»“æœ

### 2. âœ… è§†é¢‘æ£€æµ‹ï¼ˆDeepfake æ£€æµ‹ï¼‰
- **æ‘„åƒå¤´é‡‡é›†**ï¼šä½¿ç”¨å‰ç½®æ‘„åƒå¤´å®æ—¶é‡‡é›†è§†é¢‘å¸§
- **å¸§ç‡æ§åˆ¶**ï¼šæ¯ç§’é‡‡é›† 2 å¸§ï¼ˆå¯è°ƒæ•´ä¸º 1-5 å¸§ï¼‰
- **å›¾åƒå‹ç¼©**ï¼šè‡ªåŠ¨è°ƒæ•´å¤§å°åˆ° 640x480 å¹¶å‹ç¼©ä¸º JPEG æ ¼å¼
- **è§†é¢‘æ£€æµ‹ç»“æœ**ï¼šæ¥æ”¶åç«¯è¿”å›çš„ Deepfake æ£€æµ‹ç»“æœ

### 3. âœ… WebSocket å®æ—¶é€šä¿¡
- **é•¿è¿æ¥**ï¼šä¸åç«¯ä¿æŒ WebSocket é•¿è¿æ¥
- **å¿ƒè·³æœºåˆ¶**ï¼šæ¯ 30 ç§’å‘é€å¿ƒè·³ä¿æŒè¿æ¥
- **æ¶ˆæ¯ç±»å‹**ï¼šæ”¯æŒ audioã€videoã€textã€heartbeat ç­‰æ¶ˆæ¯ç±»å‹
- **ç»“æœæ¨é€**ï¼šå®æ—¶æ¥æ”¶åç«¯æ¨é€çš„æ£€æµ‹ç»“æœ

### 4. âœ… æƒé™ç®¡ç†
- **éº¦å…‹é£æƒé™**ï¼šå½•åˆ¶éŸ³é¢‘
- **æ‘„åƒå¤´æƒé™**ï¼šé‡‡é›†è§†é¢‘å¸§
- **å‰å°æœåŠ¡æƒé™**ï¼šä¿æŒåå°è¿è¡Œ
- **é€šçŸ¥æƒé™**ï¼šæ˜¾ç¤ºæ£€æµ‹è­¦å‘Š

## ğŸ“Š å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç›‘æµ‹"
   â†“
2. è¯·æ±‚éº¦å…‹é£å’Œæ‘„åƒå¤´æƒé™
   â†“
3. åˆ›å»ºé€šè¯è®°å½•ï¼ˆPOST /api/call-records/startï¼‰
   â†“
4. å»ºç«‹ WebSocket è¿æ¥
   ws://172.20.16.1:8000/api/detection/ws/{user_id}/{call_id}?token={token}
   â†“
5. å¯åŠ¨éº¦å…‹é£å½•éŸ³ï¼ˆæ¯ 3 ç§’å‘é€éŸ³é¢‘æ•°æ®ï¼‰
   â†“
6. å¯åŠ¨æ‘„åƒå¤´é‡‡é›†ï¼ˆæ¯ 0.5 ç§’å‘é€è§†é¢‘å¸§ï¼‰
   â†“
7. å®æ—¶æ›´æ–°éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º
   â†“
8. æ¥æ”¶åç«¯æ£€æµ‹ç»“æœ
   - audio_result: éŸ³é¢‘æ£€æµ‹ç»“æœ
   - video_result: è§†é¢‘æ£€æµ‹ç»“æœ
   - text_result: æ–‡æœ¬æ£€æµ‹ç»“æœ
   â†“
9. æ˜¾ç¤ºæ£€æµ‹ç»“æœå’Œé£é™©è­¦å‘Š
   â†“
10. ç”¨æˆ·ç‚¹å‡»"åœæ­¢ç›‘æµ‹"
   â†“
11. åœæ­¢å½•éŸ³å’Œæ‘„åƒå¤´
   â†“
12. å…³é—­ WebSocket è¿æ¥
```

## ğŸµ éŸ³é¢‘æ³¢å½¢å®ç°

### ä¹‹å‰ï¼ˆå‡çš„ï¼‰
```dart
// ä½¿ç”¨ sin å‡½æ•°ç”Ÿæˆçš„åŠ¨ç”»
final y = math.sin((i / size.width * waveCount * 2 * math.pi) + (progress * 2 * math.pi))
```

### ç°åœ¨ï¼ˆçœŸå®çš„ï¼‰
```dart
// ç›‘å¬éº¦å…‹é£å®æ—¶éŸ³é‡
_audioRecorder.onProgress!.listen((event) {
  if (event.decibels != null) {
    // å°†åˆ†è´å€¼è½¬æ¢ä¸º 0-1 çš„èŒƒå›´
    final normalizedLevel = (event.decibels! + 160) / 160;
    _audioWaveformData.add(normalizedLevel);
    onAudioWaveformUpdate?.call(_audioWaveformData);
  }
});
```

## ğŸ¥ è§†é¢‘é‡‡é›†å®ç°

```dart
// ä½¿ç”¨å‰ç½®æ‘„åƒå¤´
final frontCamera = cameras.firstWhere(
  (camera) => camera.lensDirection == CameraLensDirection.front,
);

// åˆå§‹åŒ–æ‘„åƒå¤´
_cameraController = CameraController(
  frontCamera,
  ResolutionPreset.medium, // ä¸­ç­‰åˆ†è¾¨ç‡
  enableAudio: false,
);

// å®šæœŸé‡‡é›†è§†é¢‘å¸§ï¼ˆæ¯ 0.5 ç§’ï¼‰
Timer.periodic(Duration(milliseconds: 500), (timer) async {
  final image = await _cameraController!.takePicture();
  final bytes = await File(image.path).readAsBytes();
  
  // å‹ç¼©å›¾åƒ
  final decodedImage = img.decodeImage(bytes);
  final resized = img.copyResize(decodedImage, width: 640, height: 480);
  final compressed = img.encodeJpg(resized, quality: 70);
  
  // å‘é€åˆ°åç«¯
  _channel!.sink.add(json.encode({
    'type': 'video',
    'data': base64Encode(compressed),
  }));
});
```

## ğŸ“¦ æ–°å¢ä¾èµ–

```yaml
dependencies:
  camera: ^0.10.5+5          # æ‘„åƒå¤´é‡‡é›†
  image: ^4.1.3              # å›¾åƒå¤„ç†å’Œå‹ç¼©
  flutter_foreground_task: ^8.0.0  # å‰å°æœåŠ¡
```

## ğŸ” æƒé™é…ç½®

### AndroidManifest.xml
```xml
<!-- æ‘„åƒå¤´æƒé™ -->
<uses-permission android:name="android.permission.CAMERA" />

<!-- å‰å°æœåŠ¡æƒé™ -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_CAMERA" />

<!-- æ‘„åƒå¤´ç‰¹æ€§å£°æ˜ -->
<uses-feature android:name="android.hardware.camera" android:required="false" />
<uses-feature android:name="android.hardware.camera.front" android:required="false" />
```

## ğŸ“± UI æ›´æ–°

### éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º
- ä»å‡çš„ sin åŠ¨ç”»æ”¹ä¸ºçœŸå®çš„éº¦å…‹é£éŸ³é‡æ•°æ®
- ä½¿ç”¨ `RealWaveformPainter` ç»˜åˆ¶å®æ—¶æ³¢å½¢
- æ˜¾ç¤º"å®æ—¶æ³¢å½¢"æ ‡ç­¾

### æƒé™æç¤º
- æ›´æ–°ä¸º"éº¦å…‹é£å’Œæ‘„åƒå¤´æƒé™"
- è¯´æ˜è§†é¢‘æ£€æµ‹åŠŸèƒ½

## ğŸ¯ æ£€æµ‹ç»“æœå¤„ç†

```dart
// éŸ³é¢‘æ£€æµ‹ç»“æœ
case 'audio_result':
  print('ğŸµ æ”¶åˆ°éŸ³é¢‘æ£€æµ‹ç»“æœ');
  onDetectionResult?.call({'audio': data['result']});
  // result: { confidence, is_fake, risk_level, method, details }

// è§†é¢‘æ£€æµ‹ç»“æœ
case 'video_result':
  print('ğŸ¥ æ”¶åˆ°è§†é¢‘æ£€æµ‹ç»“æœ');
  onDetectionResult?.call({'video': data['result']});
  // result: { confidence, is_deepfake, risk_level, threshold, model_version }

// æ–‡æœ¬æ£€æµ‹ç»“æœ
case 'text_result':
  print('ğŸ“ æ”¶åˆ°æ–‡æœ¬æ£€æµ‹ç»“æœ');
  onDetectionResult?.call({'text': data['result']});
  // result: { risk_level, label, confidence, keywords }
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‘„åƒå¤´æƒé™**ï¼šå¦‚æœç”¨æˆ·æ‹’ç»æ‘„åƒå¤´æƒé™ï¼Œç³»ç»Ÿä¼šç»§ç»­ä½¿ç”¨éŸ³é¢‘æ£€æµ‹ï¼Œä¸ä¼šé˜»æ–­æµç¨‹
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šè§†é¢‘å¸§å·²å‹ç¼©åˆ° 640x480ï¼ŒJPEG è´¨é‡ 70%ï¼Œå‡å°‘ä¼ è¾“æ•°æ®é‡
3. **ç”µæ± æ¶ˆè€—**ï¼šå®æ—¶é‡‡é›†è§†é¢‘å¸§ä¼šå¢åŠ ç”µæ± æ¶ˆè€—ï¼Œå»ºè®®åœ¨å……ç”µæ—¶ä½¿ç”¨
4. **éšç§ä¿æŠ¤**ï¼šæ‰€æœ‰éŸ³è§†é¢‘æ•°æ®ä»…ç”¨äºæ£€æµ‹ï¼Œä¸ä¼šä¿å­˜åˆ°æœ¬åœ°æˆ–äº‘ç«¯

## ğŸš€ ä½¿ç”¨æ–¹æ³•

1. æ‰“å¼€ Appï¼Œè¿›å…¥"å®æ—¶ç›‘æµ‹"é¡µé¢
2. ç‚¹å‡»"å¼€å§‹ç›‘æµ‹"æŒ‰é’®
3. æˆäºˆéº¦å…‹é£å’Œæ‘„åƒå¤´æƒé™
4. ç³»ç»Ÿå¼€å§‹å®æ—¶ç›‘æµ‹éŸ³é¢‘å’Œè§†é¢‘
5. æŸ¥çœ‹å®æ—¶æ³¢å½¢å’Œæ£€æµ‹ç»“æœ
6. å¦‚æœæ£€æµ‹åˆ°é£é™©ï¼Œä¼šæ˜¾ç¤ºè­¦å‘Š
7. ç‚¹å‡»"åœæ­¢ç›‘æµ‹"ç»“æŸæ£€æµ‹

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **éŸ³é¢‘é‡‡æ ·ç‡**ï¼š44100 Hz
- **éŸ³é¢‘æ¯”ç‰¹ç‡**ï¼š128 kbps
- **éŸ³é¢‘å‘é€é¢‘ç‡**ï¼šæ¯ 3 ç§’
- **è§†é¢‘åˆ†è¾¨ç‡**ï¼š640x480
- **è§†é¢‘å¸§ç‡**ï¼š2 FPS
- **è§†é¢‘å‹ç¼©è´¨é‡**ï¼š70%
- **å¿ƒè·³é—´éš”**ï¼š30 ç§’

## ğŸ”§ å¯è°ƒæ•´å‚æ•°

### éŸ³é¢‘
```dart
await _audioRecorder.startRecorder(
  codec: Codec.aacADTS,
  bitRate: 128000,      // å¯è°ƒæ•´ï¼š64000 - 256000
  sampleRate: 44100,    // å¯è°ƒæ•´ï¼š16000, 22050, 44100, 48000
);
```

### è§†é¢‘
```dart
// å¸§ç‡è°ƒæ•´
Timer.periodic(Duration(milliseconds: 500), ...);  // 500ms = 2 FPS
// å¯è°ƒæ•´ä¸ºï¼š1000ms (1 FPS) åˆ° 200ms (5 FPS)

// åˆ†è¾¨ç‡è°ƒæ•´
ResolutionPreset.medium  // å¯é€‰ï¼šlow, medium, high, veryHigh

// å‹ç¼©è´¨é‡è°ƒæ•´
img.encodeJpg(resized, quality: 70);  // å¯è°ƒæ•´ï¼š50-100
```

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„ App å·²ç»å…·å¤‡å®Œæ•´çš„å®æ—¶ AI æ£€æµ‹åŠŸèƒ½ï¼š
- âœ… çœŸå®éŸ³é¢‘æ³¢å½¢æ˜¾ç¤º
- âœ… éŸ³é¢‘ AI åˆæˆæ£€æµ‹
- âœ… è§†é¢‘ Deepfake æ£€æµ‹
- âœ… å®æ—¶ç»“æœæ¨é€
- âœ… é£é™©è­¦å‘Šæç¤º

å¼€å§‹æµ‹è¯•å§ï¼ğŸš€

