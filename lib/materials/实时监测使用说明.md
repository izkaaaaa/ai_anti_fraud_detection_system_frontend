# 实时监测功能使用说明

## ✅ 已完成的功能

### 1. WebSocket 实时通信
- ✅ 自动连接到后端 WebSocket 服务
- ✅ 支持模拟器和真机自动切换地址
- ✅ 心跳机制保持连接
- ✅ 自动重连（断线后）

### 2. 音频流实时传输
- ✅ 每 3 秒发送一段音频到后端
- ✅ Base64 编码传输
- ✅ 实时音频波形显示
- ✅ 音频分贝监测

### 3. 视频流实时传输
- ✅ 每秒发送 1 帧视频到后端
- ✅ 自动压缩为 640x480 JPEG 格式
- ✅ Base64 编码传输
- ✅ 使用前置摄像头

### 4. 检测结果处理
- ✅ 接收后端返回的检测结果
- ✅ 显示音频、视频、文本检测状态
- ✅ 实时更新置信度和风险等级
- ✅ 风险提示和警告

### 5. 防御等级升级
- ✅ 接收后端的控制消息
- ✅ 自动升级防御等级
- ✅ 显示全屏警告对话框
- ✅ 提供停止/继续选项

---

## 🚀 使用流程

### 1. 启动后端服务
确保后端服务已启动：
```bash
cd E:\wangtiao\AI-Anti-Fraud-Detection-System-API
python main.py
```

### 2. 配置设备模式
在 `lib/contants/index.dart` 中设置：
```dart
// 模拟器测试
static const DeviceMode CURRENT_MODE = DeviceMode.emulator;

// 真机测试
static const DeviceMode CURRENT_MODE = DeviceMode.realDevice;
```

### 3. 运行 App
```bash
flutter run
```

### 4. 进入实时监测页面
- 点击底部导航栏的"实时监测"
- 点击"开始监测"按钮
- 授予麦克风和摄像头权限

### 5. 观察检测结果
- 音频波形实时显示
- 检测结果实时更新
- 风险警告自动弹出

---

## 📊 数据流说明

### 发送到后端的数据

#### 音频数据（每 3 秒）
```json
{
  "type": "audio",
  "data": "base64编码的音频数据（AAC格式）"
}
```

#### 视频数据（每 1 秒）
```json
{
  "type": "video",
  "data": "base64编码的视频帧（JPEG格式，640x480）"
}
```

#### 心跳（每 30 秒）
```json
{
  "type": "heartbeat"
}
```

---

### 从后端接收的数据

#### ACK 确认
```json
{
  "type": "ack",
  "msg_type": "audio",
  "timestamp": "2026-02-23T10:00:00"
}
```

#### 检测结果
```json
{
  "type": "detection_result",
  "detection_type": "语音",
  "is_risk": true,
  "confidence": 0.95,
  "message": "⚠️ 检测到AI合成语音，置信度95%",
  "timestamp": "2026-02-23T10:00:03"
}
```

#### 防御升级
```json
{
  "type": "control",
  "action": "upgrade_level",
  "target_level": 2,
  "reason": "检测到AI合成语音",
  "config": {
    "ui_message": "⚠️ 警告：检测到AI合成语音，请提高警惕！",
    "show_full_screen_warning": true,
    "enable_call_recording": true
  }
}
```

---

## 🔧 技术细节

### WebSocket 连接地址
```
ws://10.0.2.2:8000/api/detection/ws/{user_id}/{call_id}?token={jwt_token}
```

### 音频参数
- 格式：AAC (ADTS)
- 采样率：44100 Hz
- 比特率：128 kbps
- 发送间隔：3 秒

### 视频参数
- 格式：JPEG
- 分辨率：640x480
- 质量：80%
- 发送间隔：1 秒（1 FPS）

### 心跳参数
- 间隔：30 秒
- 用途：保持连接活跃

---

## 🐛 调试技巧

### 1. 查看日志
在 Android Studio 或 VS Code 的 Debug Console 中查看：
```
🔌 连接 WebSocket: ws://10.0.2.2:8000/api/detection/ws/1/123?token=...
✅ WebSocket 连接成功
🎵 发送音频数据: 12345 bytes
🎥 发送视频帧: 23456 bytes (640x480)
📨 收到消息: type=detection_result
🔍 检测结果:
   类型: 语音
   风险: 是
   置信度: 95.0%
   消息: ⚠️ 检测到AI合成语音
```

### 2. 检查连接状态
- 顶部显示"已连接"绿色指示器
- 音频波形实时跳动
- 状态卡片显示"监测中"

### 3. 测试后端接口
访问后端文档：
```
http://localhost:8000/docs
```

---

## ⚠️ 常见问题

### Q1: WebSocket 连接失败
**原因：**
- 后端服务未启动
- IP 地址配置错误
- Token 过期

**解决：**
1. 检查后端是否运行：`http://10.0.2.2:8000/health`
2. 检查 `lib/contants/index.dart` 中的 `CURRENT_MODE`
3. 重新登录获取新 Token

---

### Q2: 音频/视频不发送
**原因：**
- 权限未授予
- 录音器/摄像头初始化失败

**解决：**
1. 检查权限设置
2. 查看日志中的错误信息
3. 重启 App

---

### Q3: 收不到检测结果
**原因：**
- 后端 AI 模型未加载
- 数据格式错误
- 网络延迟

**解决：**
1. 查看后端日志
2. 等待 3-14 秒（AI 推理需要时间）
3. 检查网络连接

---

### Q4: 模拟器太卡
**原因：**
- Impeller 渲染引擎负载高
- 电脑资源不足

**解决：**
1. 使用真机测试（推荐）
2. 降低视频发送频率
3. 关闭其他应用

---

## 📝 下一步计划

### 待实现功能
- [ ] 文本流实时传输（语音识别结果）
- [ ] 通话记录保存和回放
- [ ] 检测历史查看
- [ ] 风险报告生成
- [ ] 多语言支持

### 优化方向
- [ ] 降低音频/视频传输延迟
- [ ] 优化内存占用
- [ ] 添加网络状态监测
- [ ] 支持后台运行

---

## 📞 技术支持

如有问题，请查看：
- 前端代码：`lib/services/RealTimeDetectionService.dart`
- 后端文档：`lib/materials/前端对接文档-实时检测接口.md`
- 后端项目：`E:\wangtiao\AI-Anti-Fraud-Detection-System-API`

---

**最后更新：2026-02-23**

