# éå®æ—¶æ£€æµ‹æ¥å£æ–‡æ¡£

> é€‚ç”¨äºæµ‹è¯•å’Œäº‹ååˆ†æåœºæ™¯ï¼Œä¸éœ€è¦WebSocketè¿æ¥

---

## ğŸ“‹ ç›®å½•

1. [éŸ³é¢‘æ£€æµ‹](#1-éŸ³é¢‘æ£€æµ‹)
2. [è§†é¢‘æ£€æµ‹](#2-è§†é¢‘æ£€æµ‹)
3. [æ–‡æœ¬æ£€æµ‹](#3-æ–‡æœ¬æ£€æµ‹)
4. [æŸ¥è¯¢æ£€æµ‹ç»“æœ](#4-æŸ¥è¯¢æ£€æµ‹ç»“æœ)
5. [å®Œæ•´æµ‹è¯•æµç¨‹](#5-å®Œæ•´æµ‹è¯•æµç¨‹)
6. [é”™è¯¯ç è¯´æ˜](#6-é”™è¯¯ç è¯´æ˜)

---

## åŸºç¡€ä¿¡æ¯

**Base URL:** `http://localhost:8000`

**è®¤è¯æ–¹å¼:** Bearer Tokenï¼ˆJWTï¼‰

**è¯·æ±‚å¤´ï¼š**
```http
Authorization: Bearer {your_token}
Content-Type: application/json
```

---

## 1. éŸ³é¢‘æ£€æµ‹

### æ¥å£ä¿¡æ¯

```
POST /api/tasks/audio/detect
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| audio_features | Array<Array<float>> | æ˜¯ | Base64ç¼–ç çš„éŸ³é¢‘æ•°æ®æˆ–éŸ³é¢‘ç‰¹å¾ |
| call_id | int | æ˜¯ | é€šè¯è®°å½•ID |

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "audio_features": "base64ç¼–ç çš„éŸ³é¢‘æ•°æ®",
  "call_id": 123
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "ä»»åŠ¡å·²æäº¤",
  "data": {
    "task_id": "abc-123-xyz-456",
    "status": "submitted"
  }
}
```

### è¯´æ˜

- æäº¤åç«‹å³è¿”å›task_id
- å®é™…æ£€æµ‹åœ¨åå°å¼‚æ­¥è¿›è¡Œï¼ˆCeleryï¼‰
- éœ€è¦é€šè¿‡task_idæŸ¥è¯¢æ£€æµ‹ç»“æœ

---

## 2. è§†é¢‘æ£€æµ‹

### æ¥å£ä¿¡æ¯

```
POST /api/tasks/video/detect
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| frame_data | Array<Array<int>> | æ˜¯ | è§†é¢‘å¸§æ•°æ®ï¼ˆBase64ç¼–ç ï¼‰ |
| call_id | int | æ˜¯ | é€šè¯è®°å½•ID |

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "frame_data": [
    "base64ç¼–ç çš„ç¬¬1å¸§",
    "base64ç¼–ç çš„ç¬¬2å¸§",
    "base64ç¼–ç çš„ç¬¬3å¸§"
  ],
  "call_id": 123
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "ä»»åŠ¡å·²æäº¤",
  "data": {
    "task_id": "def-456-xyz-789",
    "status": "submitted"
  }
}
```

### è¯´æ˜

- å»ºè®®æ¯æ¬¡æäº¤10å¸§å·¦å³
- è§†é¢‘æ£€æµ‹è€—æ—¶è¾ƒé•¿ï¼ˆ5-10ç§’ï¼‰
- æ”¯æŒé˜²æŠ–æœºåˆ¶ï¼Œå‡å°‘è¯¯æŠ¥

---

## 3. æ–‡æœ¬æ£€æµ‹

### æ¥å£ä¿¡æ¯

```
POST /api/tasks/text/detect
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| text | string | æ˜¯ | è¦æ£€æµ‹çš„æ–‡æœ¬å†…å®¹ |
| call_id | int | æ˜¯ | é€šè¯è®°å½•ID |

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "text": "æ‚¨æ¶‰å«Œæ´—é’±ï¼Œè¯·ç«‹å³é…åˆè°ƒæŸ¥ï¼Œè½¬è´¦åˆ°å®‰å…¨è´¦æˆ·",
  "call_id": 123
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "ä»»åŠ¡å·²æäº¤",
  "data": {
    "task_id": "ghi-789-xyz-012",
    "status": "submitted"
  }
}
```

### è¯´æ˜

- æ–‡æœ¬æ£€æµ‹é€Ÿåº¦æœ€å¿«ï¼ˆ1-2ç§’ï¼‰
- ä¼˜å…ˆä½¿ç”¨è§„åˆ™å¼•æ“åŒ¹é…æ•æ„Ÿè¯
- è§„åˆ™æœªå‘½ä¸­æ—¶ä½¿ç”¨AIè¯­ä¹‰åˆ†æ

---

## 4. æŸ¥è¯¢æ£€æµ‹ç»“æœ

### æ¥å£ä¿¡æ¯

```
GET /api/tasks/status/{task_id}
```

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| task_id | string | æ˜¯ | ä»»åŠ¡IDï¼ˆæäº¤æ£€æµ‹æ—¶è¿”å›çš„ï¼‰ |

### è¯·æ±‚ç¤ºä¾‹

```
GET /api/tasks/status/abc-123-xyz-456
```

### å“åº”ç¤ºä¾‹

#### ä»»åŠ¡è¿›è¡Œä¸­

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "task_id": "abc-123-xyz-456",
    "status": "PROCESSING",
    "result": null
  }
}
```

#### éŸ³é¢‘æ£€æµ‹å®Œæˆ

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "task_id": "abc-123-xyz-456",
    "status": "SUCCESS",
    "result": {
      "status": "success",
      "result": {
        "is_fake": true,
        "confidence": 0.95,
        "risk_level": "high",
        "model_version": "v1.0"
      }
    }
  }
}
```

#### è§†é¢‘æ£€æµ‹å®Œæˆ

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "task_id": "def-456-xyz-789",
    "status": "SUCCESS",
    "result": {
      "status": "success",
      "result": {
        "is_deepfake": true,
        "confidence": 0.88,
        "model_version": "v1.0"
      },
      "debounce": {
        "final_is_fake": true,
        "fake_count": 4,
        "state": "ALARM"
      }
    }
  }
}
```

#### æ–‡æœ¬æ£€æµ‹å®Œæˆ

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "task_id": "ghi-789-xyz-012",
    "status": "SUCCESS",
    "result": {
      "status": "success",
      "result": {
        "label": "fraud",
        "confidence": 0.92,
        "matched_keyword": "æ´—é’±",
        "risk_level": "high"
      },
      "call_id": 123
    }
  }
}
```

#### ä»»åŠ¡å¤±è´¥

```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "task_id": "abc-123-xyz-456",
    "status": "FAILURE",
    "result": {
      "status": "error",
      "message": "Invalid audio format"
    }
  }
}
```

### ä»»åŠ¡çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| PENDING | ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å¤„ç† |
| PROCESSING | ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ |
| SUCCESS | ä»»åŠ¡å®Œæˆï¼Œæ£€æµ‹æˆåŠŸ |
| FAILURE | ä»»åŠ¡å¤±è´¥ |

---

## 5. å®Œæ•´æµ‹è¯•æµç¨‹

### æµç¨‹å›¾

```
1. æäº¤æ£€æµ‹ä»»åŠ¡
   POST /api/tasks/audio/detect
   POST /api/tasks/video/detect
   POST /api/tasks/text/detect
   â†“
2. è·å–task_id
   {"task_id": "abc-123-xyz"}
   â†“
3. è½®è¯¢æŸ¥è¯¢ç»“æœï¼ˆæ¯2-3ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼‰
   GET /api/tasks/status/{task_id}
   â†“
4. æ£€æŸ¥status
   - PENDING/PROCESSING â†’ ç»§ç»­è½®è¯¢
   - SUCCESS â†’ è·å–result
   - FAILURE â†’ å¤„ç†é”™è¯¯
   â†“
5. è§£ææ£€æµ‹ç»“æœ
   - is_fake/is_deepfake/label
   - confidenceï¼ˆç½®ä¿¡åº¦ï¼‰
   - risk_levelï¼ˆé£é™©ç­‰çº§ï¼‰
```

---

### ç¤ºä¾‹ï¼šæµ‹è¯•éŸ³é¢‘æ£€æµ‹

#### Step 1: æäº¤ä»»åŠ¡

```bash
curl -X POST http://localhost:8000/api/tasks/audio/detect \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "audio_features": "base64_encoded_audio_data",
    "call_id": 123
  }'
```

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "task_id": "abc-123-xyz"
  }
}
```

#### Step 2: æŸ¥è¯¢ç»“æœï¼ˆè½®è¯¢ï¼‰

```bash
# ç¬¬1æ¬¡æŸ¥è¯¢ï¼ˆæäº¤å1ç§’ï¼‰
curl http://localhost:8000/api/tasks/status/abc-123-xyz \
  -H "Authorization: Bearer your_token"

# å“åº”ï¼šä»»åŠ¡è¿›è¡Œä¸­
{
  "data": {
    "status": "PROCESSING"
  }
}

# ç¬¬2æ¬¡æŸ¥è¯¢ï¼ˆæäº¤å3ç§’ï¼‰
curl http://localhost:8000/api/tasks/status/abc-123-xyz \
  -H "Authorization: Bearer your_token"

# å“åº”ï¼šä»»åŠ¡å®Œæˆ
{
  "data": {
    "status": "SUCCESS",
    "result": {
      "is_fake": true,
      "confidence": 0.95
    }
  }
}
```

---

### ç¤ºä¾‹ï¼šæµ‹è¯•æ–‡æœ¬æ£€æµ‹

#### Step 1: æäº¤ä»»åŠ¡

```bash
curl -X POST http://localhost:8000/api/tasks/text/detect \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "æ‚¨æ¶‰å«Œæ´—é’±ï¼Œè¯·é…åˆè°ƒæŸ¥",
    "call_id": 123
  }'
```

#### Step 2: æŸ¥è¯¢ç»“æœ

```bash
curl http://localhost:8000/api/tasks/status/{task_id} \
  -H "Authorization: Bearer your_token"
```

**å“åº”ï¼š**
```json
{
  "data": {
    "status": "SUCCESS",
    "result": {
      "label": "fraud",
      "confidence": 1.0,
      "matched_keyword": "æ´—é’±",
      "risk_level": "high"
    }
  }
}
```

---

## 6. é”™è¯¯ç è¯´æ˜

### HTTPçŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 200 | è¯·æ±‚æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªæˆæƒï¼ˆTokenæ— æ•ˆæˆ–è¿‡æœŸï¼‰ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### ä¸šåŠ¡é”™è¯¯ç 

| code | message | è¯´æ˜ |
|------|---------|------|
| 200 | æˆåŠŸ | æ“ä½œæˆåŠŸ |
| 400 | å‚æ•°é”™è¯¯ | è¯·æ±‚å‚æ•°ä¸æ­£ç¡® |
| 401 | æœªæˆæƒ | Tokenæ— æ•ˆæˆ–è¿‡æœŸ |
| 404 | ä»»åŠ¡ä¸å­˜åœ¨ | task_idä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | åç«¯å¤„ç†å¼‚å¸¸ |

---

## 7. æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æç¤º

1. **Tokenè®¤è¯**
   - æ‰€æœ‰æ¥å£éƒ½éœ€è¦JWT Token
   - Tokenåœ¨è¯·æ±‚å¤´ä¸­ï¼š`Authorization: Bearer {token}`
   - Tokenè¿‡æœŸæ—¶é—´ï¼š24å°æ—¶

2. **call_idè¦æ±‚**
   - call_idå¿…é¡»å­˜åœ¨äºæ•°æ®åº“ä¸­
   - å¦‚æœä¸å­˜åœ¨ï¼Œåç«¯ä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆæµ‹è¯•ç”¨ï¼‰
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®å…ˆåˆ›å»ºé€šè¯è®°å½•

3. **è½®è¯¢é¢‘ç‡**
   - å»ºè®®æ¯2-3ç§’æŸ¥è¯¢ä¸€æ¬¡
   - ä¸è¦è¿‡äºé¢‘ç¹ï¼ˆé¿å…æœåŠ¡å™¨å‹åŠ›ï¼‰
   - æœ€å¤šè½®è¯¢30æ¬¡ï¼ˆçº¦1åˆ†é’Ÿï¼‰

4. **æ•°æ®æ ¼å¼**
   - éŸ³é¢‘ï¼šBase64ç¼–ç çš„WAV/MP3æ ¼å¼
   - è§†é¢‘ï¼šBase64ç¼–ç çš„è§†é¢‘å¸§ï¼ˆJPEG/PNGï¼‰
   - æ–‡æœ¬ï¼šUTF-8ç¼–ç çš„å­—ç¬¦ä¸²

5. **å½“å‰ä½¿ç”¨Mockæ¨¡å‹**
   - âš ï¸ æ£€æµ‹ç»“æœæ˜¯æ¨¡æ‹Ÿçš„ï¼ˆéšæœºæˆ–å›ºå®šå€¼ï¼‰
   - âœ… æ¥å£æµç¨‹å®Œå…¨å¯ç”¨
   - âœ… é€‚åˆå‰åç«¯è”è°ƒ
   - ğŸ¯ ä¸Šçº¿å‰éœ€è¦æ›¿æ¢ä¸ºçœŸå®AIæ¨¡å‹

---

## 8. æµ‹è¯•å»ºè®®

### æ¨èæµ‹è¯•é¡ºåº

1. **å…ˆæµ‹è¯•æ–‡æœ¬æ£€æµ‹**ï¼ˆæœ€ç®€å•ï¼‰
   - ä¸éœ€è¦å¤„ç†æ–‡ä»¶
   - å“åº”é€Ÿåº¦å¿«
   - å®¹æ˜“éªŒè¯ç»“æœ

2. **å†æµ‹è¯•éŸ³é¢‘æ£€æµ‹**
   - éœ€è¦Base64ç¼–ç 
   - å“åº”é€Ÿåº¦ä¸­ç­‰
   - éªŒè¯å¼‚æ­¥æµç¨‹

3. **æœ€åæµ‹è¯•è§†é¢‘æ£€æµ‹**
   - æ•°æ®é‡æœ€å¤§
   - å“åº”é€Ÿåº¦æœ€æ…¢
   - éªŒè¯å®Œæ•´æµç¨‹

### æµ‹è¯•ç”¨ä¾‹

#### æ–‡æœ¬æ£€æµ‹æµ‹è¯•ç”¨ä¾‹

```json
// æµ‹è¯•1ï¼šè¯ˆéª—è¯æœ¯ï¼ˆåº”è¯¥æ£€æµ‹ä¸ºfraudï¼‰
{
  "text": "æ‚¨æ¶‰å«Œæ´—é’±ï¼Œè¯·ç«‹å³é…åˆè°ƒæŸ¥",
  "call_id": 1
}

// æµ‹è¯•2ï¼šæ­£å¸¸å¯¹è¯ï¼ˆåº”è¯¥æ£€æµ‹ä¸ºnormalï¼‰
{
  "text": "ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™",
  "call_id": 2
}

// æµ‹è¯•3ï¼šæ•æ„Ÿè¯ï¼ˆåº”è¯¥è§¦å‘è§„åˆ™å¼•æ“ï¼‰
{
  "text": "è¯·è½¬è´¦åˆ°è¿™ä¸ªè´¦æˆ·",
  "call_id": 3
}
```

---

## 9. å¸¸è§é—®é¢˜

### Q1: æäº¤ä»»åŠ¡åå¤šä¹…èƒ½å¾—åˆ°ç»“æœï¼Ÿ

**A:** 
- æ–‡æœ¬æ£€æµ‹ï¼š1-2ç§’
- éŸ³é¢‘æ£€æµ‹ï¼š3-5ç§’
- è§†é¢‘æ£€æµ‹ï¼š5-10ç§’

### Q2: å¦‚ä½•çŸ¥é“ä»»åŠ¡å®Œæˆäº†ï¼Ÿ

**A:** è½®è¯¢æŸ¥è¯¢æ¥å£ï¼Œå½“statuså˜ä¸ºSUCCESSæˆ–FAILUREæ—¶è¡¨ç¤ºå®Œæˆã€‚

### Q3: task_idä¼šè¿‡æœŸå—ï¼Ÿ

**A:** task_idåœ¨Redisä¸­ä¿å­˜1å°æ—¶ï¼Œè¶…æ—¶åæ— æ³•æŸ¥è¯¢ã€‚

### Q4: å¯ä»¥åŒæ—¶æäº¤å¤šä¸ªä»»åŠ¡å—ï¼Ÿ

**A:** å¯ä»¥ï¼Œæ¯ä¸ªä»»åŠ¡ç‹¬ç«‹å¤„ç†ï¼Œäº’ä¸å½±å“ã€‚

### Q5: æ£€æµ‹ç»“æœä¼šä¿å­˜åˆ°æ•°æ®åº“å—ï¼Ÿ

**A:** ä¼šï¼Œæ£€æµ‹ç»“æœä¿å­˜åœ¨ä»¥ä¸‹è¡¨ä¸­ï¼š
- `ai_detection_logs` - AIæ£€æµ‹æŠ€æœ¯æ—¥å¿—
- `message_logs` - ç”¨æˆ·é€šçŸ¥æ¶ˆæ¯
- `call_records` - é€šè¯è®°å½•ï¼ˆæ›´æ–°detected_resultå­—æ®µï¼‰

---

## 10. è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»åç«¯å¼€å‘å›¢é˜Ÿã€‚

**APIæ–‡æ¡£åœ°å€ï¼š**
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2026-02-18

